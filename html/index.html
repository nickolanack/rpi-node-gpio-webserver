<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Raspberry Pi - Controls</title>
<script type="text/javascript" src="mtc-1.5.1.js"></script>
<script type="text/javascript" src="mtm-1.5.1.js"></script>
<script type="text/javascript" src="ui-c.js"></script>
<script type="text/javascript" src="ui-s.js"></script>
<script type="text/javascript" src="ui-ls.js"></script>
<link rel="stylesheet" href="style.css" />
<script type="text/javascript">


	window.addEvent('load',function(){
	

		var ws = new WebSocket('ws://'+window.location.hostname+':8080');
		console.log('started websocket: ws');
		ws.onopen=function(){
			console.log('opened: ');
			
			var counter=50;
			var message='Hello World';
			var interval=setInterval(function(){
				timer=window.performance.now();
				ws.send(message);
				console.log('sent message: '+message);
				counter--;
				if(counter==0){
					clearInterval(interval);
				}
			},1000);
			
			
		}
		
		ws.onerror=function(){
			console.log('recieved error: ');
			
		}
		
		ws.onmessage=function(message){
			console.log('recieved message: '+message+' '+(window.performance.now()-timer));
		};








	
		var getDevices=function(callback){
			
			
			//TODO: replace the following with an ajax/websocket call.
			
			callback([
				{
					name:'GPIO1',
					pin:1,
					direction:'out',
					type:'bool',
					state:true
				},
				{
					name:'GPIO2',
					pin:2,
					direction:'out',
					type:'bool',
					state:false
					
				},
				{
					name:'GPIO3',
					pin:3,
					direction:'in',
					type:'bool',
					state:true
				},
				{
					name:'GPIO4',
					pin:4,
					direction:'in',
					type:'bool',
					state:false
				}
			]);
		};
		
		
		getDevices(function(devices){
			
			Array.each(devices,function(device){
				var state=device.state;
				var container=$$('body')[0].appendChild(new Element('div'));
				var control=new UISwitchControl(container, {state:state}).addEvent("change",function(newState){
					if(state!=newState){
						//TODO update gpio pin via ajax/websocket
						state=newState;
					}
				});
				container.appendChild(new Element('label', {html:device.name}));
				if(device.direction==='out'){
					control.disable(); //display only
				}
				
				//TODO listen for changes via ajax/websocket
				
			});
			
			
		});
		
		
	});


	


</script>
</head>
<body>

</body>
</html>
